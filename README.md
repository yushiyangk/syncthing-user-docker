# syncthing-user-docker

Run Syncthing in Docker for multiple users

Each user will get their own self-contained instance of Syncthing running in Docker

## Install

Using Docker Compose:

1. Download the <code>syncthing-user-docker-<var>version</var>.zip</code> file and extract it to `/srv/docker/syncthing`

	This can be done on the command-line with

	```sh
	curl -s https://api.github.com/repos/yushiyangk/syncthing-user-docker/releases/latest | grep -F syncthing-user-docker-1. | grep -F browser_download_url | head -n 1 | cut -d ':' -f 2- | tr -d '"' | sudo wget -q -i - -P /srv/docker/syncthing/  # Download latest 1.x release
	sudo unzip /srv/docker/syncthing/syncthing-user-docker-*.zip -d /srv/docker/syncthing/
	sudo rm /srv/docker/syncthing/syncthing-user-docker-*.zip
	```

	If a previous version is already installed, you will be prompted to replace the existing files. Be careful not to clobber the existing `env`.

### Install as a service for each user

This is optional, but recommended

1. Install the Systemd template service file
	```
	sudo ln -s /srv/docker/syncthing/syncthing@.service /etc/systemd/system/syncthing@.service
	sudo systemctl daemon-reload
	```

2. For each user who should have a Syncthing instance, enable an instance of the template service and start it
	<pre><code>sudo systemctl enable syncthing@<var>username</var>
	sudo systemctl start syncthing@<var>username</var></code></pre>

	Check the status of the service instance:
	<pre><code>sudo systemctl status syncthing@<var>username</var></code></pre>


## Run

If installed as a service,

<pre><code>sudo systemctl start syncthing@<var>username</var></code></pre>

If running from Docker Compose directly, in the `/srv/docker/syncthing/` directory,

<pre><code>sudo SYNCTHING_USER=<var>username</var> docker compose -p <var>instance_name</var> up</code></pre>

where <code><var>instance_name</var></code> can be set to <code>syncthing-<var>username</var></code> unless otherwise desired. To run it in the background, add the `-d` flag after `docker compose`.


## Configure

### Configure mounts

By default, each instance of the Syncthing service is started with a **writeable** bind mount that maps `/mnt` on the host to `/mnt` inside the container.

This mount can be changed, and additional mounts can be added, by editing `/srv/docker/syncthing/compose.yaml`.

Each mount can be made read-only by adding to it the property
```
read_only: true
```

### Configure users

If Syncthing is installed as a service, a default config with sensible values will be generated when the service is first started. This section can be skipped in that case, but note that the automatically generated config assumes that the user's uid and primary gid are between 1000 and 1999 inclusive (this is usually the case).

If not starting Syncthing as a service, each user's config can be manually generated by running
<pre><code>/srv/docker/syncthing/host_generate_docker_env.sh <var>username</var></code></pre>

The config file for each user is located at <code>/home/<var>username</var>/.config/syncthing/docker_env</code> (this is specified as the `env_file` in `/srv/docker/syncthing/compose.yaml`). The default values generated are as follows:

- PUID: <code><var>user_uid</var></code>
- PGID: <code><var>user_primary_gid</var></code>
- LISTEN_PORT: 22000 + <code><var>user_uid</var></code> − 1000
- LOCAL_ANNOUNCE_PORT: 21000 + <code><var>user_uid</var></code> − 1000
- WEBUI_PORT: 28000 + <code><var>user_uid</var></code> − 1000

The permissions used by the Syncthing daemon in the container is determined by PUID and PGID, and these should match the user's identity on the host system.

#### Updating user config

Each user's config file can be changed at any time. In order for the changes to take effect, the corresponding Syncthing instance should be restarted.

If installed as a service,

<pre><code>sudo systemctl restart syncthing@<var>username</var></code></pre>

If running from Docker Compose directly, in the `/srv/docker/syncthing/` directory,

<pre><code>sudo SYNCTHING_USER=<var>username</var> docker compose -p <var>instance_name</var> down
sudo SYNCTHING_USER=<var>username</var> docker compose -p <var>instance_name</var> up</code></pre>

As before, to run it in the background, add the `-d` flag after `docker compose` in the `up` command.
